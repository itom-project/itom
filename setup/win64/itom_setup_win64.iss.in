; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!

; NOCH:
; - Autovervollständigungshilfedateien

; Ggf. zu ändern!
#define SourceDirSys32 "C:\Windows\System32"
#define SourceDirITOMBuild "${CMAKE_CURRENT_BINARY_DIR}"
#define SourceDirITOMHelp "${CMAKE_CURRENT_SOURCE_DIR}"
#define SourceDirQT "${QT_BINARY_DIR}"
#define SourceDirOpenCV "${OpenCV_BIN_DIR}"
#define ExeName "Qitom.exe"
#define Name "itom (x64)"
#define Version "${ITOM_versionString}"
#define Publisher "ITO Uni Stuttgart"
#define URL "http://www.ito.uni-stuttgart.de/"

[Setup]
; NOTE: The value of AppId uniquely identifies this application.
; Do not use the same AppId value in installers for other applications.
; (To generate a new GUID, click Tools | Generate GUID inside the IDE.)
AppId={{BC92C903-FB9E-49ED-AF5C-F43F37D3974A}
AppName={#Name}
AppVersion={#Version}
AppVerName={#Name} {#Version}
AppPublisher={#Publisher}
AppPublisherURL={#URL}
AppSupportURL={#URL}
AppUpdatesURL={#URL}
DefaultDirName={pf64}\{#Name}
DefaultGroupName={#Name}
OutputBaseFilename=setup
Compression=lzma
SolidCompression=yes

LicenseFile={#SourceDirITOMHelp}\COPYING.txt

[Dirs]
Name: "{app}\"; Permissions: everyone-modify
Name: "{app}\plugins"; Permissions: everyone-modify
Name: "{app}\plugins\demoAlgorithms"; Permissions: everyone-modify
Name: "{app}\plugins\demoAlgorithms\translation"; Permissions: everyone-modify
Name: "{app}\plugins\DummyGrabber"; Permissions: everyone-modify
Name: "{app}\plugins\DummyGrabber\translation"; Permissions: everyone-modify
Name: "{app}\plugins\DummyMotor"; Permissions: everyone-modify
Name: "{app}\plugins\DummyMotor\translation"; Permissions: everyone-modify
Name: "{app}\designer"; Permissions: everyone-modify
Name: "{app}\scripts"; Permissions: everyone-modify
Name: "{app}\demoScripts"; Permissions: everyone-modify
Name: "{app}\documentation"; Permissions: everyone-modify
Name: "{app}\itomSettings"; Permissions: everyone-modify
Name: "{app}\lib"; Permissions: everyone-modify
Name: "{app}\help"; Permissions: everyone-modify
Name: "{app}\sqldrivers"; Permissions: everyone-modify
Name: "{app}\imageformats"; Permissions: everyone-modify
Name: "{app}\translation"; Permissions: everyone-modify
Name: "{app}\itom-packages"; Permissions: everyone-modify
Name: "{app}\SDK"; Permissions: everyone-modify

[Languages]
Name: "Deutsch"; MessagesFile: "compiler:Languages\German.isl"
Name: "English"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

[Files]
Source: "{#SourceDirITOMBuild}\{#ExeName}"; DestDir: "{app}"; Flags: promptifolder

; DLLs
Source: "{#SourceDirQT}\phonon4.dll"; DestDir: "{app}"; Flags: promptifolder
;Source: "{#SourceDirQT}\Qt3Support4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtCLucene4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtCore4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtDeclarative4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtDesigner4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtDesignerComponents4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtGui4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtHelp4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtMultimedia4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtNetwork4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtOpenGL4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtScript4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtScriptTools4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtSql4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtSvg4.dll"; DestDir: "{app}"; Flags: promptifolder
;Source: "{#SourceDirQT}\QtTest4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtWebKit4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtXml4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\QtXmlPatterns4.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\qscintilla2.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirOpenCV}\opencv_core230.dll"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\sqldrivers\qsqlite4.dll"; DestDir: "{app}\sqldrivers"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qgif4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qico4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qicod4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qjpeg4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qmng4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qsvg4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qtga4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qtgad4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder
Source: "{#SourceDirQT}\..\plugins\imageformats\qtiff4.dll"; DestDir: "{app}\imageformats"; Flags: promptifolder

; Python-Scripts
Source: "{#SourceDirITOMBuild}\itoDebugger.py"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itoFunctions.py"; DestDir: "{app}"; Flags: promptifolder

; Hilfe
; Source: "{#SourceDirITOMHelp}\documentation\itom_documentation\build\qthelp\*.*"; DestDir: "{app}\documentation\itom_documentation\build\qthelp"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\docs\userDoc\build\qthelp\*.qch"; DestDir: "{app}\docs\userDoc\build\qthelp"; Flags: promptifolder
Source: "{#SourceDirQT}\assistant.exe"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\qhelpgenerator.exe"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\qcollectiongenerator.exe"; DestDir: "{app}"; Flags: promptifolder

; Sprachen
Source: "{#SourceDirITOMBuild}\translation\*.qm"; DestDir: "{app}\translation"; Flags: promptifolder
Source: "{#SourceDirQT}\..\translations\qt_??.qm"; DestDir: "{app}\translation"; Flags: promptifolder

; EXEs
Source: "{#SourceDirQT}\assistant.exe"; DestDir: "{app}"; Flags: promptifolder
Source: "{#SourceDirQT}\designer.exe"; DestDir: "{app}"; Flags: promptifolder

; vielleicht
Source: "{#SourceDirQT}\uic.exe"; DestDir: "{app}"; Flags: promptifolder  

; Default INI
Source: "{#SourceDirITOMBuild}\itomSettings\itomDefault.ini"; DestDir: "{app}\itomSettings"; Flags: promptifolder  

; Lizenz-Datei
Source: "{#SourceDirITOMHelp}\Qitom\COPYING.txt"; DestDir: "{app}"; Flags: promptifolder

; itom-packages
Source: "{#SourceDirITOMBuild}\itom-packages\*.*"; DestDir: "{app}\itom-packages"; Flags: promptifolder  
Source: "{#SourceDirITOMBuild}\itom-packages\api_generator\*.*"; DestDir: "{app}\itom-packages\api_generator"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itom-packages\abstractObjToolbar\*.*"; DestDir: "{app}\itom-packages\abstractObjToolbar"; Flags: promptifolder
;Source: "{#SourceDirITOMBuild}\itom-packages\autostart\*.*"; DestDir: "{app}\itom-packages\autostart"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itom-packages\camToolbar\*.*"; DestDir: "{app}\itom-packages\camToolbar"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itom-packages\measurementSystem\*.*"; DestDir: "{app}\itom-packages\measurementSystem"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itom-packages\mpl_itom\*.*"; DestDir: "{app}\itom-packages\mpl_itom"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itom-packages\numpy_utils\*.*"; DestDir: "{app}\itom-packages\numpy_utils"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itom-packages\plotToolBar\*.*"; DestDir: "{app}\itom-packages\plotToolBar"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\itom-packages\SurfaceCharakteristics\*.*"; DestDir: "{app}\itom-packages\SurfaceCharakteristics"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\SDK\*.*"; DestDir: "{app}\SDK"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\SDK\include\*.*"; DestDir: "{app}\SDK\include"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\SDK\include\common\*.*"; DestDir: "{app}\SDK\include\common"; Components: SDK; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\SDK\include\DataObject\*.*"; DestDir: "{app}\SDK\include\DataObject"; Components: SDK;  Flags: promptifolder
Source: "{#SourceDirITOMBuild}\SDK\include\PointCloud\*.*"; DestDir: "{app}\SDK\include\PointCloud"; Components: SDK;  Flags: promptifolder
Source: "{#SourceDirITOMBuild}\SDK\include\QPropertyEditor\*.*"; DestDir: "{app}\SDK\include\QPropertyEditor"; Components: SDK;  Flags: promptifolder
Source: "{#SourceDirITOMBuild}\SDK\lib\vc10_x64\*.*"; DestDir: "{app}\SDK\lib\vc10_x64"; Components: SDK;  Flags: promptifolder

; DesignerPlugins
Source: "{#SourceDirITOMBuild}\designer\matplotlibFigure.dll"; DestDir: "{app}\designer"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\designer\itom1DQwtFigurePlugin.dll"; DestDir: "{app}\designer"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\designer\itom2DGVFigurePlugin.dll"; DestDir: "{app}\designer"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\designer\itom2DQwtFigurePlugin.dll"; DestDir: "{app}\designer"; Flags: promptifolder

; Plugins
Source: "{#SourceDirITOMBuild}\plugins\demoAlgorithms\demoAlgorithms.dll"; DestDir: "{app}\plugins\demoAlgorithms"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\plugins\demoAlgorithms\translation\*.qm"; DestDir: "{app}\plugins\demoAlgorithms\translation"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\plugins\DummyGrabber\DummyGrabber.dll"; DestDir: "{app}\plugins\DummyGrabber"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\plugins\DummyGrabber\translation\*.qm"; DestDir: "{app}\plugins\DummyGrabber\translation"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\plugins\DummyMotor\DummyMotor.dll"; DestDir: "{app}\plugins\DummyMotor"; Flags: promptifolder
Source: "{#SourceDirITOMBuild}\plugins\DummyMotor\translation\*.qm"; DestDir: "{app}\plugins\DummyMotor\translation"; Flags: promptifolder

[Icons]
Name: "{group}\{#Name}"; Filename: "{app}\{#ExeName}"
Name: "{commondesktop}\{#Name}"; Filename: "{app}\{#ExeName}"; Tasks: desktopicon

[Run]
Filename: "{app}\{#ExeName}"; Flags: nowait postinstall skipifsilent; Description: "{cm:LaunchProgram,{#StringChange(Name, "&", "&&")}}"; Components: Main

[Types]
Name: "Install"; Description: "Installation"; Flags: iscustom

[Components]
Name: "Main"; Description: "{#Name}"; Types: Install; Flags: checkablealone fixed
Name: "SDK"; Description: "itom SDK"; Types: Install; Flags: checkablealone

[UninstallDelete]
Type: filesandordirs; Name: "{app}\{#ExeName}"

[Code]
function MsiQueryProductState(ProductCode: string): integer;
  external 'MsiQueryProductStateA@msi.dll stdcall';

const
  INSTALLSTATE_DEFAULT = 5;
  INSTALLLEVEL_MAXIMUM = $ffff;
  INSTALLSTATE_ABSENT = 2;
  RP86 =    '{196BB40D-1578-3D01-B289-BEFC77A11A1E}';  // Visual C++ 2010 Redistributable Package (x86)
  RP64 =    '{DA5E371C-6333-3D8A-93A4-6FD5B20BCC6E}';  // Visual C++ 2010 Redistributable Package (x64)
  RPIA =    '{C1A35166-4301-38E9-BA67-02823AD72A1B}';  // Visual C++ 2010 Redistributable Package (ia64) 
  RP86SP1 = '{F0C3E5D1-1ADE-321E-8167-68EF0DE699A5}';  // Visual C++ 2010 SP1 Redistributable Package (x86)
  RP64SP1 = '{1D8E6291-B0D5-35EC-8441-6616F567A0F7}';  // Visual C++ 2010 SP1 Redistributable Package (x64)
  RPIASP1 = '{88C73C1C-2DE5-3B01-AFB8-B46EF4AB41CD}';  // Visual C++ 2010 SP1 Redistributable Package (ia64)

function IsMsiProductInstalled(const ProductId: string): Boolean;
begin
  Result:= MsiQueryProductState(ProductId) = INSTALLSTATE_DEFAULT;
end;

function NeedInstallRP10(): Boolean;
begin
  Result:= not (IsMsiProductInstalled(RP64) or IsMsiProductInstalled(RP64SP1));
//                IsMsiProductInstalled(RP86) or IsMsiProductInstalled(RP86SP1));
//                IsMsiProductInstalled(RPIA) or IsMsiProductInstalled(RPIASP1));
end;
